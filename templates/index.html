<!doctype html>
<html lang="pt-PT">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steganography - Encodar / Decodar (Seguro)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="bg-slate-100 text-slate-800">
  <div class="min-h-screen flex items-start justify-center py-12 px-4">
    <div class="max-w-4xl w-full space-y-6">
      <header class="flex items-center justify-between">
        <h1 class="text-2xl font-extrabold">Steganography — Encodar / Decodar</h1>
        <div class="text-sm text-slate-500">Segurança de Informação — Projeto</div>
      </header>
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      <div class="space-y-2">
        {% for msg in messages %}
        <div class="p-4 rounded-md bg-red-50 border border-red-200 text-red-800">{{ msg }}</div>
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}
      <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <section class="bg-white p-6 rounded-2xl shadow-sm" x-data="encoder()">
          <h2 class="text-lg font-semibold mb-4">Encodar mensagem</h2>
          <form id="encodeForm" action="/encode" method="post" enctype="multipart/form-data"
            @submit.prevent="submitEncode">
            <label class="block text-sm font-medium text-slate-700">Imagem (PNG)</label>
            <input type="file" name="image" accept="image/png" required @change="onFileChange($event)"
              class="mt-1 block w-full text-sm text-slate-600" />
            
              <label class="block text-sm font-medium text-slate-700 mt-4">Mensagem</label>
            <textarea name="message" x-model="message" placeholder="Texto a esconder..."
              class="mt-1 block w-full rounded-md border-slate-200 shadow-sm p-2" rows="5"></textarea>
            <label class="block text-sm font-medium text-slate-700 mt-4">Senha (mín. 8 caracteres)</label>
            <input name="password" type="password" x-model="password" required minlength="8"
              class="mt-1 block w-full rounded-md border-slate-200 shadow-sm p-2" />
            <p class="mt-1 text-xs"
              x-text="password.length >= 8 ? '✅ Comprimento mínimo cumprido' : '⚠️ Senha muito curta'"></p>
            <label class="block text-sm font-medium text-slate-700 mt-3">Confirmar senha</label>
            <input name="password_confirm" type="password" x-model="password_confirm" required
              class="mt-1 block w-full rounded-md border-slate-200 shadow-sm p-2" />
            <p class="mt-1 text-xs" x-bind:class="passwordsMatch ? 'text-emerald-600' : 'text-rose-600'"
              x-text="passwordsMatch ? '✅ Senhas coincidem' : '❌ Senhas não coincidem'"></p>
            <div class="mt-4 flex items-center gap-3">
              <button :disabled="!canSubmit" type="submit"
                class="inline-flex items-center justify-center rounded-md bg-sky-600 text-white px-4 py-2 disabled:opacity-50">
                <span x-show="!loading">Encodar e descarregar</span>
                <span x-show="loading">A processar...</span>
              </button>
              <button type="button" @click="resetForm" class="text-sm text-slate-600">Limpar</button>
            </div>
            <p class="mt-3 text-xs text-slate-500">Nota: Use imagens PNG sem compressão (evite JPEG).</p>
          </form>
        </section>
        <section class="bg-white p-6 rounded-2xl shadow-sm" x-data="decoder()">
          <h2 class="text-lg font-semibold mb-4">Decodar mensagem</h2>
          <form id="decodeForm" action="/decode" method="post" enctype="multipart/form-data"
            @submit.prevent="submitDecode">
            <label class="block text-sm font-medium text-slate-700">Imagem (PNG)</label>
            <input type="file" name="image" accept="image/png" required @change="onFileChange($event)"
              class="mt-1 block w-full text-sm text-slate-600" />
            <label class="block text-sm font-medium text-slate-700 mt-4">Senha</label>
            <input name="password" type="password" x-model="password" required minlength="8"
              class="mt-1 block w-full rounded-md border-slate-200 shadow-sm p-2" />
            <p class="mt-1 text-xs"
              x-text="password.length >= 8 ? '✅ Comprimento mínimo cumprido' : '⚠️ Senha muito curta'"></p>
            <div class="mt-4 flex items-center gap-3">
              <button :disabled="!canSubmit" type="submit"
                class="inline-flex items-center justify-center rounded-md bg-emerald-600 text-white px-4 py-2 disabled:opacity-50">
                <span x-show="!loading">Decodar</span>
                <span x-show="loading">A processar...</span>
              </button>
              <button type="button" @click="resetForm" class="text-sm text-slate-600">Limpar</button>
            </div>
            <p class="mt-3 text-xs text-slate-500">Se a senha estiver errada ou a imagem foi alterada, a decodificação
              falhará.</p>
          </form>
        </section>
      </main>
      <footer class="text-sm text-slate-500">Feito para a disciplina de Segurança de Informação — Português (PT)
      </footer>
    </div>
  </div>
  <script>
    function encoder() {
      return {
        message: '',
        password: '',
        password_confirm: '',
        file: null,
        loading: false,
        get passwordsMatch() { return this.password !== '' && this.password === this.password_confirm },
        get canSubmit() { return this.password.length >= 8 && this.passwordsMatch && this.file },
        onFileChange(e) { this.file = e.target.files[0]; },
        resetForm() { this.message = ''; this.password = ''; this.password_confirm = ''; this.file = null; document.getElementById('encodeForm').reset(); },
        async submitEncode() {
          if (!this.canSubmit) return;
          this.loading = true;
          const form = new FormData(document.getElementById('encodeForm'));
          try {
            const res = await fetch('/encode', { method: 'POST', body: form });
            if (!res.ok) {
              window.location.href = '/';
              return;
            }
            console.log("Submitting form with password:", this.password);
            console.log("Submitting form with confirm password:", this.password_confirm);
            console.log("Submitting form with message:", this.message);
            console.log("Submitting form with file:", this.file ? this.file.name : 'No file');
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'encoded.png';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
          } catch (err) {
            console.error(err);
            window.location.href = '/';
          } finally { this.loading = false }
        }
      }
    }
    function decoder() {
      return {
        password: '',
        file: null,
        loading: false,
        get canSubmit() { return this.password.length >= 8 && this.file },
        onFileChange(e) { this.file = e.target.files[0]; },
        resetForm() { this.password = ''; this.file = null; document.getElementById('decodeForm').reset(); },
        async submitDecode() {
          if (!this.canSubmit) return;
          this.loading = true;
          const form = new FormData(document.getElementById('decodeForm'));
          try {
            const res = await fetch('/decode', { method: 'POST', body: form });
            const text = await res.text();
            document.open();
            document.write(text);
            document.close();
          } catch (err) {
            console.error(err);
            window.location.href = '/';
          } finally { this.loading = false }
        }
      }
    }
  </script>
</body>

</html>